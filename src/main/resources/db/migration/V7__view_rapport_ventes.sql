


DROP VIEW IF EXISTS vue_stock_courant;

CREATE VIEW vue_stock_courant AS
SELECT
    p.id_produit,
    p.nom,
    p.stock_initial,
    (
        (p.stock_initial + COALESCE(
                (SELECT SUM(ms.quantite)
                 FROM mouvement_stock ms
                          JOIN types_mouvement_stock tms
                               ON ms.type_mouvement_id = tms.id
                 WHERE ms.produit_id = p.id_produit
                   AND tms.type_mouvement = 'ENTREE'), 0)
            ) -
        COALESCE(
                (SELECT SUM(ms.quantite)
                 FROM mouvement_stock ms
                          JOIN types_mouvement_stock tms
                               ON ms.type_mouvement_id = tms.id
                 WHERE ms.produit_id = p.id_produit
                   AND tms.type_mouvement = 'SORTIE'), 0)
        ) AS stock_courant
FROM produits p;

INSERT INTO PUBLIC.VENTES (CLIENT_ID, DATE_VENTE, MONTANT_TOTAL, CREATED_AT, UPDATED_AT, EMPLOYE_ID, ACTIF, ETAT_ID) VALUES (1, null, 539.96, '2025-03-18 07:18:50.187475', '2025-03-22 07:18:50.187475', 1, true, 3);
INSERT INTO PUBLIC.VENTES (CLIENT_ID, DATE_VENTE, MONTANT_TOTAL, CREATED_AT, UPDATED_AT, EMPLOYE_ID, ACTIF, ETAT_ID) VALUES (1, null, 164.99, '2025-03-16 07:25:55.191000', '2025-03-22 07:25:55.191833', 1, true, 3);
INSERT INTO PUBLIC.VENTES (CLIENT_ID, DATE_VENTE, MONTANT_TOTAL, CREATED_AT, UPDATED_AT, EMPLOYE_ID, ACTIF, ETAT_ID) VALUES (1, null, 149.99, '2025-03-24 07:28:44.924000', '2025-03-22 07:28:44.924182', 1, true, 3);
INSERT INTO PUBLIC.VENTES (CLIENT_ID, DATE_VENTE, MONTANT_TOTAL, CREATED_AT, UPDATED_AT, EMPLOYE_ID, ACTIF, ETAT_ID) VALUES (1, null, 449.97, '2025-03-22 07:37:27.348153', '2025-03-22 07:37:27.347152', 1, true, 3);
INSERT INTO PUBLIC.VENTES (CLIENT_ID, DATE_VENTE, MONTANT_TOTAL, CREATED_AT, UPDATED_AT, EMPLOYE_ID, ACTIF, ETAT_ID) VALUES (1, null, 1699.91, '2025-01-22 14:55:20.721000', '2025-03-22 14:55:20.720980', 1, true, 3);
INSERT INTO PUBLIC.VENTES (CLIENT_ID, DATE_VENTE, MONTANT_TOTAL, CREATED_AT, UPDATED_AT, EMPLOYE_ID, ACTIF, ETAT_ID) VALUES (1, null, 349.97, '2025-02-22 14:56:01.094000', '2025-03-22 14:56:01.094487', 1, true, 3);
INSERT INTO PUBLIC.VENTES (CLIENT_ID, DATE_VENTE, MONTANT_TOTAL, CREATED_AT, UPDATED_AT, EMPLOYE_ID, ACTIF, ETAT_ID) VALUES (1, null, 29.98, '2025-03-22 14:57:18.494905', '2025-03-22 14:57:18.494905', 1, true, 3);
INSERT INTO PUBLIC.VENTES (CLIENT_ID, DATE_VENTE, MONTANT_TOTAL, CREATED_AT, UPDATED_AT, EMPLOYE_ID, ACTIF, ETAT_ID) VALUES (1, null, 14.99, '2025-03-22 15:12:32.786403', '2025-03-22 15:12:32.785405', 1, true, 3);



INSERT INTO PUBLIC.LIGNES_VENTES (VENTE_ID, PRODUIT_ID, QUANTITE, PRIX_VENTE_UNITAIRE, ACTIF) VALUES (1, 1, 2, 179.99, true);
INSERT INTO PUBLIC.LIGNES_VENTES (VENTE_ID, PRODUIT_ID, QUANTITE, PRIX_VENTE_UNITAIRE, ACTIF) VALUES (1, 2, 1, 79.99, true);
INSERT INTO PUBLIC.LIGNES_VENTES (VENTE_ID, PRODUIT_ID, QUANTITE, PRIX_VENTE_UNITAIRE, ACTIF) VALUES (1, 3, 1, 99.99, true);
INSERT INTO PUBLIC.LIGNES_VENTES (VENTE_ID, PRODUIT_ID, QUANTITE, PRIX_VENTE_UNITAIRE, ACTIF) VALUES (2, 4, 1, 149.99, true);
INSERT INTO PUBLIC.LIGNES_VENTES (VENTE_ID, PRODUIT_ID, QUANTITE, PRIX_VENTE_UNITAIRE, ACTIF) VALUES (3, 4, 1, 149.99, true);
INSERT INTO PUBLIC.LIGNES_VENTES (VENTE_ID, PRODUIT_ID, QUANTITE, PRIX_VENTE_UNITAIRE, ACTIF) VALUES (4, 4, 3, 149.99, true);
INSERT INTO PUBLIC.LIGNES_VENTES (VENTE_ID, PRODUIT_ID, QUANTITE, PRIX_VENTE_UNITAIRE, ACTIF) VALUES (5, 4, 3, 149.99, true);
INSERT INTO PUBLIC.LIGNES_VENTES (VENTE_ID, PRODUIT_ID, QUANTITE, PRIX_VENTE_UNITAIRE, ACTIF) VALUES (2, 5, 1, 15.00, true);
INSERT INTO PUBLIC.LIGNES_VENTES (VENTE_ID, PRODUIT_ID, QUANTITE, PRIX_VENTE_UNITAIRE, ACTIF) VALUES (5, 10, 4, 299.99, true);
INSERT INTO PUBLIC.LIGNES_VENTES (VENTE_ID, PRODUIT_ID, QUANTITE, PRIX_VENTE_UNITAIRE, ACTIF) VALUES (6, 10, 1, 299.99, true);
INSERT INTO PUBLIC.LIGNES_VENTES (VENTE_ID, PRODUIT_ID, QUANTITE, PRIX_VENTE_UNITAIRE, ACTIF) VALUES (5, 12, 2, 24.99, true);
INSERT INTO PUBLIC.LIGNES_VENTES (VENTE_ID, PRODUIT_ID, QUANTITE, PRIX_VENTE_UNITAIRE, ACTIF) VALUES (6, 12, 2, 24.99, true);
INSERT INTO PUBLIC.LIGNES_VENTES (VENTE_ID, PRODUIT_ID, QUANTITE, PRIX_VENTE_UNITAIRE, ACTIF) VALUES (7, 13, 2, 14.99, true);
INSERT INTO PUBLIC.LIGNES_VENTES (VENTE_ID, PRODUIT_ID, QUANTITE, PRIX_VENTE_UNITAIRE, ACTIF) VALUES (8, 13, 1, 14.99, true);

